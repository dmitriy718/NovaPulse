# ============================================
# AI Trading Bot - Master Configuration
# ============================================

app:
  name: "AI Crypto Trading Bot"
  version: "3.0.0"
  mode: "paper"  # paper | live
  log_level: "INFO"
  db_path: "data/trading.db"
  trading_exchanges: ""  # e.g. "kraken,coinbase" (env TRADING_EXCHANGES also supported)
  account_id: "default"
  trading_accounts: ""  # e.g. "main:kraken,main:coinbase,swing:kraken"

exchange:
  name: "kraken"  # kraken | coinbase
  ws_url: "wss://ws.kraken.com/v2"
  ws_auth_url: "wss://ws-auth.kraken.com/v2"
  rest_url: "https://api.kraken.com"
  rate_limit_per_second: 15
  max_retries: 5
  retry_base_delay: 1.0
  timeout: 30
  maker_fee: 0.0016
  taker_fee: 0.0026
  post_only: false
  limit_chase_attempts: 2
  limit_chase_delay_seconds: 2.0
  limit_fallback_to_market: true

trading:
  pairs:
    - "BTC/USD"
    - "ETH/USD"
    - "SOL/USD"
    - "XRP/USD"
    - "ADA/USD"
    - "DOT/USD"
    - "AVAX/USD"
    - "LINK/USD"
  scan_interval_seconds: 20   # Faster scan cadence to increase entry opportunities
  position_check_interval_seconds: 2
  hft_scan_interval_seconds: 1
  candle_poll_seconds: 60     # REST candle poll interval (used for Coinbase)
  warmup_bars: 900     # 15 hours of 1-min data — ensures 60 fifteen-min candles for MTF
  warmup_timeframe: "1m"
  timeframes: [1, 5, 15]   # Multi-timeframe: run strategies on all 3, require 2/3 agreement
  max_concurrent_positions: 8
  cooldown_seconds: 30
  max_spread_pct: 0.0030
  use_closed_candles_only: true
  strategy_cooldowns_seconds:
    keltner: 120
    mean_reversion: 120
    ichimoku: 120
    order_flow: 120
    trend: 120
    stochastic_divergence: 120
    volatility_squeeze: 120
    supertrend: 120
    reversal: 120
  event_price_move_pct: 0.003
  single_strategy_mode: null    # or "keltner", "trend", "mean_reversion", etc. for testing
  quiet_hours_utc: []  # Disabled to allow 24/7 crypto entries
  max_trades_per_hour: 20
  canary_mode: false
  canary_pairs: ["BTC/USD", "ETH/USD"]  # Optional explicit subset; empty = first N from trading.pairs
  canary_max_pairs: 2
  canary_max_position_usd: 100.0
  canary_max_risk_per_trade: 0.005
  canary_min_confidence: 0.68
  canary_min_confluence: 3
  canary_scan_interval_seconds: 60

strategies:
  # Keltner Channel — proven winner (100% WR, 2 trades)
  keltner:
    enabled: true
    ema_period: 20
    atr_period: 14
    kc_multiplier: 1.5
    macd_fast: 12
    macd_slow: 26
    macd_signal: 9
    rsi_period: 14
    rsi_long_max: 45
    rsi_short_min: 55
    weight: 0.30
  # Mean Reversion — proven winner (80% WR, 5 trades)
  mean_reversion:
    enabled: true
    bb_period: 50
    bb_std: 2.5
    rsi_oversold: 25
    rsi_overbought: 75
    weight: 0.25
  # Ichimoku Cloud — replaces VWAP Momentum Alpha
  ichimoku:
    enabled: true
    tenkan_period: 9
    kijun_period: 26
    senkou_b_period: 52
    atr_period: 14
    weight: 0.15
  # Order Flow — microstructure-based, uses order book data
  order_flow:
    enabled: true
    book_score_threshold: 0.3
    spread_tight_pct: 0.0010
    hl_lookback: 5
    max_book_age_seconds: 5
    atr_period: 14
    weight: 0.15
  # Trend — untested, fundamentally sound
  trend:
    enabled: true
    ema_fast: 20
    ema_slow: 50
    adx_threshold: 30
    weight: 0.15
  # Stochastic Divergence — replaces RSI Mean Reversion
  stochastic_divergence:
    enabled: true
    k_period: 14
    d_period: 3
    smooth: 3
    oversold: 20.0
    overbought: 80.0
    divergence_lookback: 20
    atr_period: 14
    weight: 0.12
  # Volatility Squeeze — replaces Breakout (TTM Squeeze concept)
  volatility_squeeze:
    enabled: true
    bb_period: 20
    bb_std: 2.0
    kc_ema_period: 20
    kc_atr_period: 14
    kc_multiplier: 1.5
    momentum_period: 12
    atr_period: 14
    min_squeeze_bars: 3
    weight: 0.12
  # Supertrend — ATR-based adaptive trend with volume confirmation
  supertrend:
    enabled: true
    st_period: 10
    st_multiplier: 3.0
    volume_period: 20
    volume_threshold: 1.2
    atr_period: 14
    weight: 0.10
  # Reversal — untested, fundamentally sound
  reversal:
    enabled: true
    rsi_extreme_low: 15
    rsi_extreme_high: 85
    confirmation_candles: 5
    weight: 0.10

ai:
  confluence_threshold: 2  # 2 strategies agreeing = tradable (3 was too strict, rejected most setups)
  min_confidence: 0.55     # More permissive to restore trade flow in paper/live scan loops
  min_risk_reward_ratio: 1.2  # Lowered from 1.5 — crypto setups often have 1.2-1.3 R:R
  tflite_model_path: "models/trade_predictor.tflite"
  order_book_depth: 25
  obi_threshold: 0.15  # Order Book Imbalance threshold
  book_score_threshold: 0.2
  book_score_max_age_seconds: 5
  multi_timeframe_min_agreement: 2    # Need 2 of 3 timeframes to agree
  primary_timeframe: 5                # 5-min as primary — better signal quality than 1-min
  obi_counts_as_confluence: true  # OBI as confluence vote — adds 1 extra vote when book agrees (OBI+1 strat = 2 = tradable)
  obi_weight: 0.4
  allow_keltner_solo: true
  allow_any_solo: false
  keltner_solo_min_confidence: 0.55
  solo_min_confidence: 0.67
  whale_threshold_usd: 50000
  strategy_guardrails_enabled: true
  strategy_guardrails_min_trades: 20
  strategy_guardrails_window_trades: 30
  strategy_guardrails_min_win_rate: 0.35
  strategy_guardrails_min_profit_factor: 0.85
  strategy_guardrails_disable_minutes: 120
  session:
    enabled: true
    min_trades_per_hour: 5
    max_boost: 1.15
    max_penalty: 0.70
  regime:
    adx_trend_threshold: 25
    atr_pct_high: 0.02
    atr_pct_low: 0.008
    trend_weight_multipliers:
      trend: 1.3
      ichimoku: 1.2
      supertrend: 1.2
      order_flow: 1.1
      volatility_squeeze: 1.1
      mean_reversion: 0.8
      stochastic_divergence: 0.8
      reversal: 0.7
      keltner: 0.9
    range_weight_multipliers:
      mean_reversion: 1.3
      stochastic_divergence: 1.3
      keltner: 1.2
      reversal: 1.1
      order_flow: 1.1
      trend: 0.8
      ichimoku: 0.8
      supertrend: 0.8
      volatility_squeeze: 0.9
    high_vol_weight_multipliers:
      volatility_squeeze: 1.3
      supertrend: 1.1
      order_flow: 1.1
      mean_reversion: 0.9
      stochastic_divergence: 0.9
      reversal: 0.9
    low_vol_weight_multipliers:
      mean_reversion: 1.2
      stochastic_divergence: 1.2
      keltner: 1.1
      volatility_squeeze: 0.8
      supertrend: 0.9
      ichimoku: 0.9

risk:
  max_risk_per_trade: 0.01   # 1% of bankroll — doubled from 0.5% for better compounding
  max_daily_loss: 0.05      # 5% max daily drawdown
  max_daily_trades: 0       # 0 = disabled, set e.g. 40 to hard-cap daily churn
  max_position_usd: 350.0   # Increased from 200 — was too small to compound
  max_total_exposure_pct: 0.50  # Sum of open positions as % of bankroll
  initial_bankroll: 5000.0
  atr_multiplier_sl: 2.0
  atr_multiplier_tp: 3.0
  trailing_activation_pct: 0.04   # 4% profit to activate trailing — let winners develop
  trailing_step_pct: 0.008        # 0.8% trailing step
  breakeven_activation_pct: 0.03  # 3% profit to move SL to breakeven — well past noise zone
  kelly_fraction: 0.25            # Quarter-Kelly for safety
  max_kelly_size: 0.10            # Never more than 10% of bankroll
  risk_of_ruin_threshold: 0.01    # 1% acceptable risk of ruin
  global_cooldown_seconds_on_loss: 60  # Reduce post-loss freeze to keep trade cadence healthy
  smart_exit:
    enabled: false   # Off by default — enable after testing
    tiers:
      - pct: 0.50    # Close 50% of remaining position
        tp_mult: 1.0  # At 1x original TP distance from entry
      - pct: 0.60    # Close 60% of remaining (= 30% of original)
        tp_mult: 1.5  # At 1.5x TP distance
      - pct: 1.0     # Close 100% of remaining (= 20% of original)
        tp_mult: 0    # 0 = no fixed TP, trailing stop only

webhooks:
  enabled: false
  secret: ""
  allowed_sources: []
  max_timestamp_skew_seconds: 300

stocks:
  enabled: false
  symbols: ["AAPL", "MSFT", "NVDA", "TSLA"]
  options_enabled: false
  option_symbols: []   # Example: ["O:AAPL260116C00250000"]
  option_contract_multiplier: 100
  scan_interval_seconds: 900
  lookback_bars: 120
  min_hold_days: 1
  max_hold_days: 7
  max_open_positions: 4
  max_position_usd: 500.0
  stop_loss_pct: 0.02
  take_profit_pct: 0.04
  estimated_fee_pct_per_side: 0.0005
  estimated_slippage_pct_per_side: 0.0002
  db_path: "data/stocks.db"
  polygon_api_key: ""   # or set POLYGON_API_KEY env
  polygon_base_url: "https://api.polygon.io"
  alpaca_api_key: ""    # or set ALPACA_API_KEY env
  alpaca_api_secret: "" # or set ALPACA_API_SECRET env
  alpaca_base_url: "https://paper-api.alpaca.markets"

control:
  web:
    enabled: true
  telegram:
    enabled: true
    token: ""   # or set TELEGRAM_BOT_TOKEN
    chat_ids: []  # allowlist of Telegram chat IDs (or set TELEGRAM_CHAT_ID)
    secrets_dir: ".secrets"
    polling_enabled: false  # enable only on ONE deployment per bot token (Telegram 409 otherwise)
    send_checkins: true
    checkin_interval_minutes: 30
  discord:
    enabled: false
    token: ""
    allowed_channel_ids: []
    allowed_guild_id: null
  slack:
    enabled: false
    token: ""
    signing_secret: ""
    allowed_channel_id: null

billing:
  stripe:
    enabled: false
    secret_key: ""       # sk_test_... or sk_live_... (or STRIPE_SECRET_KEY env)
    webhook_secret: ""   # whsec_... (or STRIPE_WEBHOOK_SECRET env)
    price_id: ""         # Legacy/default Stripe Price ID (maps to pro when price_id_pro empty)
    price_id_pro: ""     # Stripe Price ID for Pro monthly plan (e.g. 49.99)
    price_id_premium: "" # Stripe Price ID for Premium monthly plan (e.g. 79.99)
    currency: usd
  tenant:
    default_tenant_id: default

dashboard:
  host: "0.0.0.0"
  port: 8080
  thought_feed_max: 200
  refresh_interval_ms: 1000
  # Strongly recommended if the dashboard is reachable outside localhost/LAN.
  # When true, reads + /ws/live require X-API-Key (admin or tenant key).
  require_api_key_for_reads: true
  # When false (default), only DASHBOARD_SECRET_KEY can run control actions.
  # Set true if you want tenant API keys to be able to pause/resume/close_all.
  allow_tenant_keys_for_control: false
  rate_limit_enabled: true
  rate_limit_requests_per_minute: 240
  rate_limit_burst: 60

ml:
  retrain_interval_hours: 168  # Weekly
  min_samples: 500  # Lowered from 10000 — start training early, retrain as data grows
  epochs: 50
  batch_size: 64
  validation_split: 0.2
  features:
    - "rsi"
    - "ema_ratio"
    - "bb_position"
    - "adx"
    - "volume_ratio"
    - "obi"
    - "atr_pct"
    - "momentum_score"
    - "trend_strength"
    - "spread_pct"

tuner:
  enabled: true
  interval_hours: 168        # Weekly
  min_trades_per_strategy: 15
  weight_bounds: [0.05, 0.50]
  auto_disable_sharpe: -0.3
  auto_disable_min_trades: 30

elasticsearch:
  enabled: true  # Analytics/enrichment mirror only; canonical trade ledger remains SQLite.
  hosts:
    - "https://my-elasticsearch-project-b2c677.es.us-central1.gcp.elastic.cloud:443"
  api_key: ""   # Set via ES_API_KEY env var or paste here
  cloud_id: ""  # Optional: Elastic Cloud ID (alternative to hosts)
  index_prefix: "novapulse"
  bulk_size: 500
  flush_interval_seconds: 10
  buffer_maxlen: 10000
  retention_days:
    candles: 90
    orderbook: 30
    sentiment: 180
    onchain: 180
    market: 180
    trades: 365
  poll_intervals:
    fear_greed: 3600       # 1 hour
    coingecko: 600         # 10 min
    cryptopanic: 600       # 10 min
    onchain: 3600          # 1 hour
  # API keys (or set via env: COINGECKO_API_KEY, CRYPTOPANIC_API_KEY)
  coingecko_api_key: ""
  cryptopanic_api_key: ""

monitoring:
  health_check_interval: 30
  auto_restart: true
  max_restart_attempts: 10
  heartbeat_interval: 10
  metrics_retention_hours: 72
  auto_pause_on_stale_data: true
  stale_data_pause_after_checks: 3
  auto_pause_on_ws_disconnect: true
  ws_disconnect_pause_after_seconds: 300
  auto_pause_on_consecutive_losses: true
  consecutive_losses_pause_threshold: 4
  auto_pause_on_drawdown: true
  drawdown_pause_pct: 8.0
  emergency_close_on_auto_pause: false

stress_test:
  duration_hours: 72
  crash_interval_minutes: 30
  network_drop_duration_seconds: 10
  cpu_spike_duration_seconds: 5
