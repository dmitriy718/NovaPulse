# ============================================
# AI Trading Bot - Master Configuration
# ============================================

app:
  name: "AI Crypto Trading Bot"
  version: "3.0.0"
  mode: "paper"  # paper | live
  log_level: "INFO"
  db_path: "data/trading.db"

exchange:
  name: "kraken"  # kraken | coinbase
  ws_url: "wss://ws.kraken.com/v2"
  ws_auth_url: "wss://ws-auth.kraken.com/v2"
  rest_url: "https://api.kraken.com"
  rate_limit_per_second: 15
  max_retries: 5
  retry_base_delay: 1.0
  timeout: 30
  maker_fee: 0.0016
  taker_fee: 0.0026
  post_only: false
  limit_chase_attempts: 2
  limit_chase_delay_seconds: 2.0
  limit_fallback_to_market: true

trading:
  pairs:
    - "BTC/USD"
    - "ETH/USD"
    - "SOL/USD"
    - "XRP/USD"
    - "ADA/USD"
    - "DOT/USD"
    - "AVAX/USD"
    - "LINK/USD"
  scan_interval_seconds: 30   # More frequent scans = more chances to catch setups
  position_check_interval_seconds: 2
  hft_scan_interval_seconds: 1
  candle_poll_seconds: 60     # REST candle poll interval (used for Coinbase)
  warmup_bars: 720     # 12 hours of 1-min data for indicator convergence
  warmup_timeframe: "1m"
  timeframes: [1, 5, 15]
  max_concurrent_positions: 5
  cooldown_seconds: 120
  max_spread_pct: 0.0015
  use_closed_candles_only: true
  strategy_cooldowns_seconds:
    keltner: 300
    trend: 300
    mean_reversion: 300
    momentum: 300
    vwap_momentum_alpha: 300
    rsi_mean_reversion: 300
    breakout: 300
    reversal: 300
  event_price_move_pct: 0.003
  single_strategy_mode: null    # or "keltner", "trend", "mean_reversion", etc. for testing
  quiet_hours_utc: [2, 3, 4, 5]  # Skip new entries during low-liquidity UTC hours (empty list = disabled)

strategies:
  # Keltner Channel — primary strategy for high win rate
  keltner:
    enabled: true
    ema_period: 20
    atr_period: 14
    kc_multiplier: 1.5
    macd_fast: 12
    macd_slow: 26
    macd_signal: 9
    rsi_period: 14
    rsi_long_max: 45   # Slightly relaxed so more long setups qualify
    rsi_short_min: 55  # Slightly relaxed so more short setups qualify
    weight: 0.35
  # Tuned for 1-MINUTE candles — longer periods to filter noise
  trend:
    enabled: true
    ema_fast: 20        # ~20 min fast EMA (was 5)
    ema_slow: 50        # ~50 min slow EMA (was 13)
    adx_threshold: 30   # Stricter trend filter (was 25)
    weight: 0.25
  mean_reversion:
    enabled: true
    bb_period: 50       # 50-min Bollinger (was 20)
    bb_std: 2.5         # Wider bands = fewer false signals
    rsi_oversold: 25    # More extreme = higher conviction (was 30)
    rsi_overbought: 75  # (was 70)
    weight: 0.30
  momentum:
    enabled: false  # 1/12 wins (8%) — momentum signals on 1-min data have no edge
    rsi_threshold: 55
    volume_multiplier: 2.0
    weight: 0.20
  vwap_momentum_alpha:
    enabled: true
    vwap_window: 20
    band_std: 1.5
    pullback_z: 0.6
    slope_period: 5
    volume_multiplier: 1.2
    pullback_z_trend_adjust: -0.12
    pullback_z_range_adjust: 0.12
    pullback_z_high_vol_adjust: 0.10
    pullback_z_low_vol_adjust: -0.05
    slope_min_pct: 0.0005
    weight: 0.12
  rsi_mean_reversion:
    enabled: true
    rsi_period: 14
    rsi_oversold: 30
    rsi_overbought: 70
    trend_adjust: 5
    range_adjust: 5
    high_vol_adjust: 3
    low_vol_adjust: 2
    weight: 0.20
  breakout:
    enabled: false  # 0/10 wins — S/R breakouts on 1-min candles are pure noise
    lookback_period: 60
    volume_confirmation: 1.8
    weight: 0.20
  reversal:
    enabled: true
    rsi_extreme_low: 15   # Very extreme only (was 20)
    rsi_extreme_high: 85  # (was 80)
    confirmation_candles: 5  # More confirmation bars (was 3)
    weight: 0.15

ai:
  confluence_threshold: 2  # 2 strategies agreeing = tradable (3 was too strict, rejected most setups)
  min_confidence: 0.60     # Lowered from 0.68 — AI blending + opposition penalty was killing valid trades
  min_risk_reward_ratio: 1.2  # Lowered from 1.5 — crypto setups often have 1.2-1.3 R:R
  tflite_model_path: "models/trade_predictor.tflite"
  order_book_depth: 25
  obi_threshold: 0.15  # Order Book Imbalance threshold
  book_score_threshold: 0.2
  book_score_max_age_seconds: 5
  multi_timeframe_min_agreement: 2
  primary_timeframe: 1
  obi_counts_as_confluence: true  # OBI as confluence vote — adds 1 extra vote when book agrees (OBI+1 strat = 2 = tradable)
  obi_weight: 0.4
  allow_keltner_solo: false
  allow_any_solo: false
  keltner_solo_min_confidence: 0.62
  solo_min_confidence: 0.67
  whale_threshold_usd: 50000
  regime:
    adx_trend_threshold: 25
    atr_pct_high: 0.02
    atr_pct_low: 0.008
    trend_weight_multipliers:
      trend: 1.3
      momentum: 1.2
      vwap_momentum_alpha: 1.2
      breakout: 1.1
      mean_reversion: 0.8
      rsi_mean_reversion: 0.8
      reversal: 0.7
      keltner: 0.9
    range_weight_multipliers:
      mean_reversion: 1.3
      rsi_mean_reversion: 1.3
      keltner: 1.2
      reversal: 1.1
      trend: 0.8
      momentum: 0.8
      vwap_momentum_alpha: 0.8
      breakout: 0.8
    high_vol_weight_multipliers:
      breakout: 1.2
      momentum: 1.1
      vwap_momentum_alpha: 1.1
      mean_reversion: 0.9
      rsi_mean_reversion: 0.9
      reversal: 0.9
    low_vol_weight_multipliers:
      mean_reversion: 1.2
      rsi_mean_reversion: 1.2
      keltner: 1.1
      breakout: 0.9
      momentum: 0.9
      vwap_momentum_alpha: 0.9

risk:
  max_risk_per_trade: 0.01   # 1% of bankroll — doubled from 0.5% for better compounding
  max_daily_loss: 0.05      # 5% max daily drawdown
  max_position_usd: 350.0   # Increased from 200 — was too small to compound
  initial_bankroll: 5000.0
  atr_multiplier_sl: 2.0
  atr_multiplier_tp: 3.0
  trailing_activation_pct: 0.04   # 4% profit to activate trailing — let winners develop
  trailing_step_pct: 0.008        # 0.8% trailing step
  breakeven_activation_pct: 0.03  # 3% profit to move SL to breakeven — well past noise zone
  kelly_fraction: 0.25            # Quarter-Kelly for safety
  max_kelly_size: 0.10            # Never more than 10% of bankroll
  risk_of_ruin_threshold: 0.01    # 1% acceptable risk of ruin
  global_cooldown_seconds_on_loss: 180  # 3 min cooldown after loss (was 10 min — freezing bot too long)

control:
  web:
    enabled: true
  telegram:
    enabled: true
    token: ""   # or set TELEGRAM_BOT_TOKEN
    chat_ids: []  # allowlist of Telegram chat IDs (or set TELEGRAM_CHAT_ID)
    secrets_dir: ".secrets"
    polling_enabled: false  # enable only on ONE deployment per bot token (Telegram 409 otherwise)
    send_checkins: true
    checkin_interval_minutes: 30
  discord:
    enabled: false
    token: ""
    allowed_channel_ids: []
    allowed_guild_id: null
  slack:
    enabled: false
    token: ""
    signing_secret: ""
    allowed_channel_id: null

billing:
  stripe:
    enabled: false
    secret_key: ""       # sk_test_... or sk_live_... (or STRIPE_SECRET_KEY env)
    webhook_secret: ""   # whsec_... (or STRIPE_WEBHOOK_SECRET env)
    price_id: ""         # Stripe Price ID for monthly plan (price_...)
    currency: usd
  tenant:
    default_tenant_id: default

dashboard:
  host: "0.0.0.0"
  port: 8080
  thought_feed_max: 200
  refresh_interval_ms: 1000
  # Strongly recommended if the dashboard is reachable outside localhost/LAN.
  # When true, reads + /ws/live require X-API-Key (admin or tenant key).
  require_api_key_for_reads: true
  # When false (default), only DASHBOARD_SECRET_KEY can run control actions.
  # Set true if you want tenant API keys to be able to pause/resume/close_all.
  allow_tenant_keys_for_control: false
  rate_limit_enabled: true
  rate_limit_requests_per_minute: 240
  rate_limit_burst: 60

ml:
  retrain_interval_hours: 168  # Weekly
  min_samples: 500  # Lowered from 10000 — start training early, retrain as data grows
  epochs: 50
  batch_size: 64
  validation_split: 0.2
  features:
    - "rsi"
    - "ema_ratio"
    - "bb_position"
    - "adx"
    - "volume_ratio"
    - "obi"
    - "atr_pct"
    - "momentum_score"
    - "trend_strength"
    - "spread_pct"

monitoring:
  health_check_interval: 30
  auto_restart: true
  max_restart_attempts: 10
  heartbeat_interval: 10
  metrics_retention_hours: 72
  auto_pause_on_stale_data: true
  stale_data_pause_after_checks: 3
  auto_pause_on_ws_disconnect: true
  ws_disconnect_pause_after_seconds: 300

stress_test:
  duration_hours: 72
  crash_interval_minutes: 30
  network_drop_duration_seconds: 10
  cpu_spike_duration_seconds: 5
